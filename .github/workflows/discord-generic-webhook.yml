name: Discord (Generic Webhook) on push
on: { push: {} }

jobs:
  generic-webhook:
    runs-on: ubuntu-latest
    env:
      LOREM_LENGTH: ${{ vars.LOREM_LENGTH }}
      DISCORD_HOOK: ${{ secrets.DISCORD_HOOK }}
    steps:
      - name: Build body (embed with ```text)
        id: build
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import os, json
          n = int(os.getenv("LOREM_LENGTH") or "4000")
          base = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. "
          s = (base * ((n // len(base)) + 2))[:n]
          payload = {
            "embeds": [{
              "title": "Lorem sample (Generic)",
              "description": f"```text\n{s}\n```"
            }]
          }
          # JSON فشرده تا خروجی یک‌خطی شود
          open("body.json","w",encoding="utf-8").write(
            json.dumps(payload, ensure_ascii=False, separators=(',',':'))
          )
          PY
          # خواندن فایل و گذاشتن در خروجی استپ
          echo "json=$(cat body.json)" >> "$GITHUB_OUTPUT"

      - name: Send via joelwmale/webhook-action
        uses: joelwmale/webhook-action@v2.4.1
        with:
          url: ${{ env.DISCORD_HOOK }}
          headers: '{"Content-Type":"application/json"}'
          body: ${{ steps.build.outputs.json }}
