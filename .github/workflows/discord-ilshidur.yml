name: Discord (Ilshidur) on push
on:
  push: {}

jobs:
  ilshidur:
    runs-on: ubuntu-latest
    env:
      # Set this in repo "Variables" (optional). If unset, defaults to 500.
      LOREM_LENGTH: ${{ vars.LOREM_LENGTH }}
      # Set this in repo "Secrets": DISCORD_HOOK
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_HOOK }}

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Build embeds JSON
        shell: bash
        run: |
          set -euo pipefail
          python3 -c 'import os,json
n=int(os.getenv("LOREM_LENGTH") or "500")
base="Lorem ipsum dolor sit amet, consectetur adipiscing elit. "
s=(base*((n//len(base))+2))[:n]
embeds={"embeds":[{"title":"Lorem sample (Ilshidur)","description":f"```text\n{s}\n```"}]}
open("embeds.json","w",encoding="utf-8").write(json.dumps(embeds, ensure_ascii=False))'

      - name: Export DISCORD_EMBEDS to env
        shell: bash
        run: |
          set -euo pipefail
          {
            echo 'DISCORD_EMBEDS<<__EMBEDS__'
            cat embeds.json
            echo '__EMBEDS__'
          } >> "$GITHUB_ENV"

      - name: Send via Ilshidur/action-discord
        uses: Ilshidur/action-discord@0.4.0
        env:
          DISCORD_WEBHOOK: ${{ env.DISCORD_WEBHOOK }}
          DISCORD_EMBEDS: ${{ env.DISCORD_EMBEDS }}
        with:
          args: "sending embedâ€¦"

      # Optional: quick sanity check
      - name: Log payload size
        if: always()
        shell: bash
        run: wc -c < embeds.json
